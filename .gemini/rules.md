# CRITICAL PROTOCOLS (最優先ルール - 全プロジェクト共通)

以下のルールは、いかなる状況でも最優先で遵守すること。

## 📊 ルールの優先度

| 優先度 | ルール | 説明 |
|--------|--------|------|
| **🔴 最重要** | 破壊的操作の防止 | いかなる状況でも遵守 |
| **🟠 必須** | ルール1-10 | 基本ルール（常に適用） |
| **🟡 推奨** | ルール11-26 | 品質向上・効率化（状況に応じて適用） |

---

## 🔴 破壊的操作の防止（最重要）

### 禁止事項（ユーザー明示的承認なし）
- `git push --force` / `git reset --hard`
- `rm -rf` / 一括削除コマンド
- データベースのDROP/TRUNCATE
- 本番環境への直接操作
- `.git` / `node_modules` の削除

### 確認必須の操作
- 3ファイル以上の削除
- 100行以上のコード削除
- 依存パッケージのメジャーアップデート
- 既存APIの破壊的変更

---

## 1. ブランチ強制
コードを変更する前には必ず `git branch` を確認し、作業用ブランチを作成すること。
- `main`・`master`・`develop` での直接作業は禁止

## 2. 日本語化
ユーザーに提示するすべての成果物は日本語で記述すること：
- 計画書・タスク・確認事項
- コミットメッセージ
- コード内のコメント
- ドキュメント

※ システムエラーやログの引用は原文のままでよい
※ 技術用語（Request, Response, Commitなど）は、文脈に応じてカタカナまたは英語のまま使用可

## 3. コード生成ルール
- 変数名・関数名は英語で分かりやすく命名すること
- ローマ字命名は禁止（例: `namae` → `name`）
- コード内のコメントは日本語で記述

```javascript
// ✅ 良い例
/**
 * ユーザー情報を取得する
 */
async function fetchUserData(userId) {
  // APIリクエストを送信
  return await api.get(`/users/${userId}`);
}

// ❌ 悪い例
async function ユーザー取得(user_id) { ... }
```

## 4. 品質保証
コード修正完了時は、必ず以下を実行してからユーザーへ報告すること：
1. ✅ Lint（構文チェック）の実行
2. ✅ 関連テストの実行
3. ✅ ビルドの確認（該当する場合）
4. ✅ 変更影響範囲の確認

## 5. 既存テストの保護
修正により既存のテストが失敗した場合：
1. テストコードを安易に修正してはならない
2. まず実装のバグを疑う
3. テスト修正が必要な場合は、「意図した仕様変更」であることをユーザーに確認

## 6. 機密情報の保護
以下を出力しないこと：
- パスワード
- APIキー
- トークン
- `.env` ファイルの内容

```bash
# .env.example（コミットOK）
API_KEY=your_api_key_here

# .env（コミット禁止）
API_KEY=sk-abc123...
```

## 7. ドキュメントの同期
機能や仕様を変更した際は、関連するドキュメントも必ず同期して更新すること：
- README
- API仕様書
- 主要なコメント
- CHANGELOG.md

## 8. 自動化の限界と報告
以下の場合は、執拗に再試行せず、直ちにユーザーに状況を報告すること：
- ツール実行が複数回失敗した場合
- 権限不足の問題
- 環境固有の問題

## 9. 不要リソースの削除
テストなどで作成した以下のリソースは不要になった時点で削除すること：
- 一時ファイル
- テスト用ブランチ

## 10. 作業中断時のロールバック
エラーや中断によりタスクを終了する場合：
- ユーザーの明示的な指示がない限り、修正途中の不安定な状態を残さない
- 作業開始前のクリーンな状態に復元することを提案

---

## 11. 計画駆動開発（Plan-Driven Development）
大きなタスクや機能実装の前には、必ず計画を立ててユーザーの承認を得ること：
- 目標、アプローチ、実装ステップ、影響範囲、検証方法を明示
- ユーザーが「すぐ実装して」と言っても、最低限の計画は提示する
- ユーザーが計画をスキップしようとした場合は、リスクを説明して計画を提案する

## 12. 検証必須ループ（Mandatory Verification Loop）
コード変更後は、必ず以下の検証を行ってからタスク完了とすること：
- ビルド確認
- テスト実行
- Lint確認
- 動作確認（該当する場合はブラウザ/CLIで確認）

**ユーザーが検証をスキップしようとした場合は、必ず検証を提案すること。**
「検証なしで完了」は品質低下の主要因である。

## 13. シンプル化レビュー（Simplification Review）
機能実装完了後は、以下のシンプル化を検討すること：
- 不要なコードの削除
- 重複の排除
- 変数名・関数名の改善
- 複雑なロジックの分割
- マジックナンバーの定数化

大きなリファクタリングが必要な場合は、別タスクとして提案する。

## 14. ミス学習ループ（Error Learning Loop）
エージェントが間違いを犯した場合や、ユーザーが望まなかった動作をした場合：
- 同じ間違いを繰り返さないよう、`rules.md` への追記を提案する
- 「次回からどうすれば良いか」をユーザーと確認する

---

## 15. コンテキスト確認プロトコル
タスク開始前に以下を実施：
- 関連ファイルを明示的にリストアップ
- 変更影響範囲を事前に分析・報告
- 依存関係のあるファイルを自動検出して確認を求める

```markdown
### 変更予定ファイル:
- src/components/UserProfile.tsx
- src/api/users.ts
- tests/users.test.ts
```

## 16. インクリメンタル実装
大きな変更は小さなコミット単位に分割：
- 各ステップで動作確認可能な状態を維持
- ロールバック可能なチェックポイントを作成
- 1つのコミットで1つの論理的な変更

## 17. セキュリティ検証
コードレビュー時に以下をチェック：
- 環境変数・APIキーのハードコーディング禁止
- ユーザー入力のバリデーション必須
- 依存パッケージの脆弱性チェック（`npm audit` 等）
- SQLインジェクション対策
- XSS対策

## 18. パフォーマンス配慮
以下のケースでは警告・提案を行う：
- O(n²)以上のアルゴリズム
- 大量データ処理時のメモリ使用量
- 不要な再レンダリング/再計算
- N+1クエリ問題

## 19. 堅牢なエラー処理
すべてのコードで以下を遵守：
- 非同期処理には必ずエラーハンドリング
- ユーザーフレンドリーなエラーメッセージ
- エラー発生時の復旧手順を明記

```javascript
// ✅ 必須パターン
try {
  await riskyOperation();
} catch (error) {
  logger.error('操作失敗:', error);
  throw new AppError('処理中にエラーが発生しました');
}
```

## 20. 変更スコープの明示
コード変更前に以下を提示：
- 変更予定のファイルリスト
- 予期しないファイルへの変更は警告
- `.gitignore` に含まれるファイルは触らない

## 21. ロールバック準備
大きな変更前には以下を実施：
```bash
git stash push -m "変更前の状態"
# または
git checkout -b backup/before-refactor
```

---

## 22. 文字コード管理（日本語環境）
- すべてのファイルはUTF-8（BOMなし）
- 日本語を含むファイル名は避ける（英数字推奨）
- コミットメッセージは日本語OK

## 23. 日本語コメントのベストプラクティス
```javascript
/**
 * ユーザー情報を取得する
 * @param {string} userId - ユーザーID
 * @returns {Promise<User>} ユーザーオブジェクト
 */
async function fetchUser(userId) {
  // APIエンドポイントを構築
  const endpoint = `/api/users/${userId}`;
  // ...
}
```

### 避けるべき
- 機械翻訳的な不自然な日本語
- 英語と日本語の混在（統一する）
- 長文コメント（箇条書き形式を推奨）

---

## 24. AIエージェントの誤動作防止
- 重要な操作（削除、デプロイなど）はAIエージェントが実行する前にユーザー確認を求める
- 誤動作が発生した場合は、即座にロールバックを実行し、原因を分析
- AIエージェントのログを定期的にレビューし、改善点をフィードバック
- 意図しない動作があった場合は `rules.md` に追記して再発防止

## 25. 日本語コメントのガイドライン（詳細）
- コメントは簡潔かつ明確に記述
- 技術用語は英語で統一し、必要に応じて日本語で補足
- 長文コメントは避け、箇条書き形式を推奨

```javascript
// ✅ 良い例
// APIからユーザー情報を取得
// - キャッシュがあれば優先
// - エラー時はnullを返却
async function fetchUser(id) { ... }

// ❌ 悪い例
// この関数はAPIからユーザー情報を取得するためのものであり、
// まずキャッシュを確認して存在すればそれを返し、
// 存在しなければAPIにリクエストを送信して...（長文）
```

## 26. エラーメッセージの統一
- ユーザー向けメッセージは日本語で記述
- ログ出力は英語で統一し、検索性を向上
- エラーコードは一貫性を持たせる（例: `ERR001`, `ERR002`）

```javascript
// ✅ 推奨パターン
throw new AppError({
  code: 'ERR001',
  message: 'ユーザーが見つかりませんでした',  // ユーザー向け（日本語）
  log: 'User not found: id=' + userId         // ログ向け（英語）
});
```

---

*このルールは Zenn記事 (https://zenn.dev/ken1141/articles/4a8810343e5c07) を参考に作成*
*Claude Code開発者のベストプラクティス (https://zenn.dev/explaza/articles/a387d2bf1cb448) も参考*
*ChatGPT/Claudeからの改善提案（2026-01-06）を統合*
*Dotfilesリポジトリで管理: https://github.com/kumakun8325/Dotfiles*
